messiaen.audio = function () { var e = {}; var f = []; var g = ['C', 'C#/Db', 'D', 'D#/Eb', 'E', 'F', 'F#/Gb', 'G', 'G#/Ab', 'A', 'Bb', 'B']; var h = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B']; var l = []; var m = 100; var n = []; var o = false; e.initialise = function () { var a = (BrowserDetect.browser === "Opera" || BrowserDetect.browser === "Firefox") ? "Audio/Ogg/" : "Audio/Mp3/"; var b = (BrowserDetect.browser === "Opera" || BrowserDetect.browser === "Firefox") ? ".ogg" : ".mp3"; for (var j = 0; j < 5; j++) { for (var k = 0; k < 12; k++) { f.push({ pitch: g[k], audio: a + h[k] + "/" + (j + 1) + b, id: g[k] + (j + 1), loaded: false }) } } for (var i = 0; i < m; i++) { var c = []; c["channel"] = new Audio(); c["finished"] = -1; n.push(c) } }; e.loadPitch = function (a) { for (var i = 0, length = f.length; i < length, note = f[i]; i++) { if (note.pitch === a && !note.loaded) { var b = document.createElement("audio"); b.setAttribute("preload", "auto"); b.setAttribute("id", note.id); b.setAttribute("src", note.audio); document.body.appendChild(b); f[i].loaded = true } } }; var p = []; var q = function () { var a = document.getElementById(l[0]); for (var i = 0; i < m; i++) { var b = new Date(); if (n[i]['finished'] < b.getTime()) { n[i]['finished'] = b.getTime() + a.duration * 1000; n[i]['channel'].src = a.src; n[i]['channel'].load(); n[i]['channel'].play(); break } } p.push(l[0]); l.splice(0, 1); if (l.length > 0) { setTimeout(q, 150) } else { setTimeout(r, 900) } }; var r = function () { var a = document.getElementById(p[0]); for (var i = 0; i < m; i++) { var b = new Date(); if (n[i]['finished'] < b.getTime()) { n[i]['finished'] = b.getTime() + a.duration * 1000; n[i]['channel'].src = a.src; n[i]['channel'].load(); n[i]['channel'].play(); break } } p.splice(0, 1); if (p.length > 0) { r() } else { o = false; document.getElementById("playMessiaenChordButton").children[0].style.display = "block"; document.getElementById("playMessiaenChordButton").children[1].style.display = "none" } }; e.playChord = function (a) { if (!o) { o = true; document.getElementById("playMessiaenChordButton").children[0].style.display = "none"; document.getElementById("playMessiaenChordButton").children[1].style.display = "block"; var b = []; var c = 0; var d = false; for (var i = 0, length = a.length; i < length, pitch = a[i]; i++) { d = false; for (var j = c, length = f.length; j < length; j++) { if (f[j].pitch === pitch) { if (f[j].loaded === false) { messiaen.audio.loadPitch(pitch) } b.push(f[j].id); c = j; d = true; break } } if (!d) { for (var j = c; j >= 0; j--) { if (f[j].pitch === pitch) { if (f[j].loaded === false) { messiaen.audio.loadPitch(pitch) } b.push(f[j].id); c = j; d = true; break } } } } s(b) } }; var s = function (a) { if (a && a.length !== 0) { var b = true; for (var i = 0, length = a.length; i < length; i++) { if (!document.getElementById(a[i]).readyState) { b = false; break } } if (b) { for (var k = 0, length = a.length; k < length; k++) { l.push(a[k]) } q() } else { setTimeout(function () { s(a) }, 100) } } else { document.getElementById("playMessiaenChordButton").children[0].style.display = "block"; document.getElementById("playMessiaenChordButton").children[1].style.display = "none" } }; return e } ();