var messiaen=messiaen?messiaen:{};messiaen.diagram=function(){var e={},t={background:"dbcebb",heading:"212136",circle:"1E0F13",defaultText:"fff",selectedText:"1E0F13",highlightedText:"AC2017",modeShape:"fff",chordShape:"AC2017"},n=["C#/Db","D","D#/Eb","E","F","F#/Gb","G","G#/Ab","A","Bb","B","C"],o=[{pitchIndex:11,lower:-1/12,upper:1/12,middle:0},{pitchIndex:10,lower:1/12,upper:.25,middle:2/12},{pitchIndex:9,lower:.25,upper:5/12,middle:4/12},{pitchIndex:8,lower:5/12,upper:7/12,middle:.5},{pitchIndex:7,lower:7/12,upper:.75,middle:8/12},{pitchIndex:6,lower:.75,upper:11/12,middle:10/12},{pitchIndex:5,lower:11/12,upper:13/12,middle:1},{pitchIndex:4,lower:13/12,upper:1.25,middle:14/12},{pitchIndex:3,lower:1.25,upper:17/12,middle:16/12},{pitchIndex:2,lower:17/12,upper:19/12,middle:1.5},{pitchIndex:1,lower:19/12,upper:1.75,middle:20/12},{pitchIndex:0,lower:1.75,upper:23/12,middle:22/12}],i=[{name:"First mode / Whole-tone scale",construction:[2,2,2,2,2]},{name:"Second mode / Diminished scale",construction:[1,2,1,2,1,2,1]},{name:"Third mode",construction:[2,1,1,2,1,1,2,1]},{name:"Fourth mode",construction:[1,1,3,1,1,1,3]},{name:"Fifth mode",construction:[1,4,1,1,4]},{name:"Sixth mode",construction:[2,2,1,1,2,2,1]},{name:"Seventh mode",construction:[1,1,1,2,1,1,1,1,2]}],c=null,r=null,l=null,a=null,d=null,u=[],s=[],h=[],m=11,f=0,p=0,x=[],v=!1,g=null,T=!1,I=null,y=0,b=null;e.initialise=function(){BrowserDetect.init(),messiaen.audio.initialise(),c=document.getElementById("messiaenDiagram"),c.width=document.documentElement.clientHeight-170,c.height=document.documentElement.clientHeight-170,r=c.getContext("2d");var e=document.getElementById("modeSelect");e.selectedIndex=0,e.onchange=function(){var e=document.getElementById("modeSelect");f=Number(e.children[e.selectedIndex].value),h=[],T=!0};var t=document.getElementById("keySelect");t.selectedIndex=0,t.onchange=function(){var e=m,t=document.getElementById("keySelect");m=Number(t.children[t.selectedIndex].value),h=[],C(e)},"ontouchstart"in document.documentElement?(document.getElementById("playMessiaenChordButton").addEventListener("touchstart",function(){return F(),!1},!1),document.getElementById("clearMessiaenChordButton").addEventListener("touchstart",function(){return h=[],T=!0,!1},!1),c.addEventListener("touchstart",function(e){return I=new Date,v=!0,null!==b&&(window.clearTimeout(b),b=null),A(e),document.addEventListener("touchmove",j,!1),document.addEventListener("touchend",function(){v=!1,g=null,c.removeEventListener("touchmove"),c.removeEventListener("touchend"),I=null,M()},!1),!1},!1)):(c.onclick=A,document.getElementById("playMessiaenChordButton").onclick=function(){F()},document.getElementById("clearMessiaenChordButton").onclick=function(){h=[],T=!0},c.onmousedown=function(){return I=new Date,v=!0,null!==b&&(window.clearTimeout(b),b=null),c.style.cursor="pointer",document.onmousemove=j,document.onmouseup=function(){c.style.cursor="default",document.documentElement.style.cursor="default",v=!1,g=null,document.onmousemove=function(){},document.onmouseup=function(){},I=null,M()},!1}),T=!0,window.setInterval(function(){O(p)},25)};var M=function(){y>1||-1>y?b=setTimeout(function(){p-=1/1024*y,0>p?p=2+p:p>=2&&(p-=2),T=!0,y*=.992,M()},1):(b=null,y=0)};e.getPitchObjects=function(){return u};var w=function(){c.width=c.width,s=[],u=[],x=[]},E=function(){return[[1,0,0],[0,1,0],[0,0,1]]},O=function(){if(T){T=!1,w();var e={x:c.width/2,y:c.height/2},n=c.height/2-50;if(P(p,e,n),r.setTransform(1,0,0,1,0,0),r.beginPath(),s.length>1){r.strokeStyle="#"+t.modeShape,r.lineWidth=4,r.moveTo(u[s[0]].lineTransformationMatrix[2][0],u[s[0]].lineTransformationMatrix[2][1]);for(var o=s.length-1;o>=0;)r.lineTo(u[s[o]].lineTransformationMatrix[2][0],u[s[o]].lineTransformationMatrix[2][1]),o--;r.stroke()}if(r.closePath(),r.setTransform(1,0,0,1,0,0),r.beginPath(),r.strokeStyle="#"+t.circle,r.lineWidth=5,r.arc(e.x,e.y,n,0,2*Math.PI,!1),r.stroke(),r.closePath(),r.setTransform(1,0,0,1,0,0),r.beginPath(),h.length>1){r.strokeStyle="#"+t.chordShape,r.lineWidth=2,r.moveTo(u[h[0]].lineTransformationMatrix[2][0],u[h[0]].lineTransformationMatrix[2][1]);for(var o=1;o<h.length;)r.lineTo(u[h[o]].lineTransformationMatrix[2][0],u[h[o]].lineTransformationMatrix[2][1]),o++;r.stroke()}r.closePath(),T=!1}},P=function(e,o,c){r.beginPath(),r.font="300 24px Roboto, Arial, Helvetica, sans-serif",r.fillStyle="#"+t.defaultText,r.textAlign="center";var p=i[f],x=m;s.push(x);for(var v=0,g=p.construction.length;g>v;v++)x+=p.construction[v],x=x>=12?x-12:x,s.push(x);for(var v=0,g=n.length;pitch=n[v];v++){r.fillStyle=-1!==s.indexOf(v)?"#"+t.selectedText:"#"+t.defaultText,-1!==h.indexOf(v)&&(r.fillStyle="#"+t.highlightedText);var T=Math.round(Math.cos((v+10)*Math.PI/6)*c),I=Math.round(Math.sin((v+10)*Math.PI/6)*c);S(1,0,0,1,o.x,o.y),B(1.06,1.06),k(e*Math.PI),D(T,I),k((v+1)*Math.PI/6),"Safari"!==BrowserDetect.browser?r.fillText(pitch,0,0):r.strokeText(pitch,0,0),a=l,S(1,0,0,1,o.x,o.y),B(.973,.973),k(e*Math.PI),D(T,I),k((v+1)*Math.PI/6),d=l,u.push({pitchIndex:v,pitchTransformationMatrix:a,lineTransformationMatrix:d})}r.closePath()};e.getPitches=function(){return u};var S=function(e,t,n,o,i,c){r.setTransform(e,t,n,o,i,c),l=[[e,n,0],[t,o,0],[i,c,1]]},B=function(e,t){r.scale(e,t);var n=[[e,0,0],[0,t,0],[0,0,1]];l=W(n,l)},k=function(e){r.rotate(e);var t=[[Math.cos(e),Math.sin(e),0],[-Math.sin(e),Math.cos(e),0],[0,0,1]];l=W(t,l)},D=function(e,t){r.translate(e,t);var n=[[1,0,0],[0,1,0],[e,t,1]];l=W(n,l)},L=function(e,t){var n,o;return void 0!==e.touches?(n=e.touches[0].pageX+document.body.scrollLeft+document.documentElement.scrollLeft,o=e.touches[0].pageY+document.body.scrollTop+document.documentElement.scrollTop):void 0!=e.pageX&&void 0!=e.pageY?(n=e.pageX,o=e.pageY):(n=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,o=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t&&(n-=c.offsetLeft,o-=c.offsetTop),{x:n,y:o}},j=function(e){if(void 0!==e.touches?1===e.touches.length&&e.preventDefault():e.preventDefault(),v){document.documentElement.style.cursor="pointer";var t=L(e,!1);null===g&&(g=t);var n=g.x-t.x,o=g.y-t.y,i=c.offsetTop+c.height/2,r=c.offsetLeft+c.width/2;t.y>i&&(n*=-1),t.x<r&&(o*=-1);var l=Math.abs(n)>Math.abs(o)?n:o;y=l/(new Date-I),p-=1/1024*l,0>p?p=2+p:p>=2&&(p-=2),g=t,T=!0,O(p),I=new Date}},A=function(e){if(null===b){var t=L(e,!0),o=0;for(u.length;pitchObject=u[o];o++)t.x<=pitchObject.pitchTransformationMatrix[2][0]+30&&t.x>=pitchObject.pitchTransformationMatrix[2][0]-30&&t.y<=pitchObject.pitchTransformationMatrix[2][1]+30&&t.y>=pitchObject.pitchTransformationMatrix[2][1]-30&&(-1!==s.indexOf(pitchObject.pitchIndex)&&-1===h.indexOf(pitchObject.pitchIndex)?(h.push(pitchObject.pitchIndex),T=!0,messiaen.audio.loadPitch(n[pitchObject.pitchIndex])):-1!==h.indexOf(pitchObject.pitchIndex)&&(h.splice(h.indexOf(pitchObject.pitchIndex),1),T=!0))}},C=function(e){for(var t=e,n=0;t!=m;)n++,t++,12===t&&(t=0);var i=0;for(o.length;pitchAngle=o[i];i++)if(pitchAngle.pitchIndex===m){(p<pitchAngle.middle-1/64||p>pitchAngle.middle+1/64)&&(6>=n?(p-=1/64,0>p&&(p=2+p)):(p+=1/64,p>=2&&(p-=2)),T=!0,setTimeout(function(){C(e)},1));break}},F=function(){for(var e=[],t=0,o=h.length;o>t;t++)e.push(n[h[t]]);messiaen.audio.playChord(e)},W=function(e,t){for(var n=E(),o=0;3>o;o++)for(var i=0;3>i;i++){for(var c=0,r=0;3>r;r++)c+=e[o][r]*t[r][i];n[o][i]=c}return n};return e}(),window.onload=function(){messiaen.diagram.initialise()};