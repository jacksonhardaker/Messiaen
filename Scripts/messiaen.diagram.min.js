var messiaen = {}; messiaen.diagram = function () { var h = {}; var n = { background: "dbcebb", heading: "212136", circle: "100900", defaultText: "b59354", selectedText: "212136", highlightedShadow: "212136", modeShape: "ccc1af", chordShape: "61301d" }; var o = ["C#/Db", "D", "D#/Eb", "E", "F", "F#/Gb", "G", "G#/Ab", "A", "Bb", "B", "C"]; var p = [{ pitchIndex: 11, lower: -1 / 12, upper: 1 / 12, middle: 0 }, { pitchIndex: 10, lower: 1 / 12, upper: 3 / 12, middle: 2 / 12 }, { pitchIndex: 9, lower: 3 / 12, upper: 5 / 12, middle: 4 / 12 }, { pitchIndex: 8, lower: 5 / 12, upper: 7 / 12, middle: 6 / 12 }, { pitchIndex: 7, lower: 7 / 12, upper: 9 / 12, middle: 8 / 12 }, { pitchIndex: 6, lower: 9 / 12, upper: 11 / 12, middle: 10 / 12 }, { pitchIndex: 5, lower: 11 / 12, upper: 13 / 12, middle: 12 / 12 }, { pitchIndex: 4, lower: 13 / 12, upper: 15 / 12, middle: 14 / 12 }, { pitchIndex: 3, lower: 15 / 12, upper: 17 / 12, middle: 16 / 12 }, { pitchIndex: 2, lower: 17 / 12, upper: 19 / 12, middle: 18 / 12 }, { pitchIndex: 1, lower: 19 / 12, upper: 21 / 12, middle: 20 / 12 }, { pitchIndex: 0, lower: 21 / 12, upper: 23 / 12, middle: 22 / 12}]; var q = [{ name: "First mode / Whole-tone scale", construction: [2, 2, 2, 2, 2] }, { name: "Second mode / Diminished scale", construction: [1, 2, 1, 2, 1, 2, 1] }, { name: "Third mode", construction: [2, 1, 1, 2, 1, 1, 2, 1] }, { name: "Fourth mode", construction: [1, 1, 3, 1, 1, 1, 3] }, { name: "Fifth mode", construction: [1, 4, 1, 1, 4] }, { name: "Sixth mode", construction: [2, 2, 1, 1, 2, 2, 1] }, { name: "Seventh mode", construction: [1, 1, 1, 2, 1, 1, 1, 1, 2]}]; var r = null; var s = null; var t = null; var u = null; var v = null; var w = null; var A = []; var B = []; var C = []; var D = 11; var E = 0; var F = 0; var G = []; var H = null; var I = false; var J = null; var K = false; var L = null; var M = 0; var N = null; h.initialise = function () { BrowserDetect.init(); messiaen.audio.initialise(); r = document.getElementById("messiaenDiagram"); r.width = document.documentElement.clientHeight - 170; r.height = document.documentElement.clientHeight - 170; s = r.getContext("2d"); var b = document.getElementById("modeSelect"); b.selectedIndex = 0; b.onchange = function (e) { var l = document.getElementById("modeSelect"); E = Number(l.children[l.selectedIndex].value); C = []; K = true }; var c = document.getElementById("keySelect"); c.selectedIndex = 0; c.onchange = function (e) { var a = D; var l = document.getElementById("keySelect"); D = Number(l.children[l.selectedIndex].value); C = []; bc(a) }; if ('ontouchstart' in document.documentElement) { document.getElementById("instructionsLink").addEventListener("touchstart", function () { if (document.getElementById("instructionsContent").style.display === "block") { document.getElementById("instructionsContent").style.display = "none" } else { document.getElementById("instructionsContent").style.display = "block" } }, false); document.getElementById("playMessiaenChordButton").addEventListener("touchstart", function (e) { bd(); return false }, false); document.getElementById("clearMessiaenChordButton").addEventListener("touchstart", function (e) { C = []; K = true; return false }, false); r.addEventListener('touchstart', function (e) { L = new Date(); I = true; if (N !== null) { window.clearTimeout(N); N = null } ba(e); document.addEventListener('touchmove', Y, false); document.addEventListener('touchend', function (e) { I = false; J = null; r.removeEventListener('touchmove'); r.removeEventListener('touchend'); L = null; O() }, false); return false }, false) } else { document.getElementById("instructionsLink").onclick = function () { if (document.getElementById("instructionsContent").style.display === "block") { document.getElementById("instructionsContent").style.display = "none" } else { document.getElementById("instructionsContent").style.display = "block" } }; r.onclick = ba; document.getElementById("playMessiaenChordButton").onclick = function () { bd() }; document.getElementById("clearMessiaenChordButton").onclick = function () { C = []; K = true }; r.onmousedown = function () { L = new Date(); I = true; if (N !== null) { window.clearTimeout(N); N = null } r.style.cursor = "pointer"; document.onmousemove = Y; document.onmouseup = function () { r.style.cursor = "default"; document.documentElement.style.cursor = "default"; I = false; J = null; document.onmousemove = function () { }; document.onmouseup = function () { }; L = null; O() }; return false } } K = true; window.setInterval(function () { R(F) }, 25) }; var O = function () { if (M > 1 || M < -1) { N = setTimeout(function () { F -= (1 / 1024) * M; if (F < 0) { F = 2 + F } else if (F >= 2) { F = F - 2 } K = true; M *= 0.992; O() }, 1) } else { N = null; M = 0 } }; h.getPitchObjects = function () { return A }; var P = function () { r.width = r.width; B = []; A = []; G = [] }; var Q = function () { return [[1, 0, 0], [0, 1, 0], [0, 0, 1]] }; var R = function (a) { if (K) { K = false; P(); var b = { x: r.width / 2, y: r.height / 2 }; var c = (r.height / 2) - 50; S(F, b, c); s.setTransform(1, 0, 0, 1, 0, 0); s.beginPath(); s.shadowColor = "rgba(0,0,0,0)"; s.shadowOffsetX = 0; s.shadowOffsetY = 0; s.shadowBlur = 0; if (B.length > 1) { s.strokeStyle = "#" + n.modeShape; s.lineWidth = 4; s.moveTo(A[B[0]].lineTransformationMatrix[2][0], A[B[0]].lineTransformationMatrix[2][1]); var j = B.length - 1; while (j >= 0) { s.lineTo(A[B[j]].lineTransformationMatrix[2][0], A[B[j]].lineTransformationMatrix[2][1]); j-- } s.stroke() } s.closePath(); s.setTransform(1, 0, 0, 1, 0, 0); s.beginPath(); s.strokeStyle = "#" + n.circle; s.lineWidth = 5; s.arc(b.x, b.y, c, 0, Math.PI * 2, false); s.stroke(); s.closePath(); s.setTransform(1, 0, 0, 1, 0, 0); s.beginPath(); s.shadowColor = "rgba(0,0,0,0)"; s.shadowOffsetX = 0; s.shadowOffsetY = 0; s.shadowBlur = 0; if (C.length > 1) { s.strokeStyle = "#" + n.chordShape; s.lineWidth = 2; s.moveTo(A[C[0]].lineTransformationMatrix[2][0], A[C[0]].lineTransformationMatrix[2][1]); var j = 1; while (j < C.length) { s.lineTo(A[C[j]].lineTransformationMatrix[2][0], A[C[j]].lineTransformationMatrix[2][1]); j++ } s.stroke() } s.closePath(); K = false } }; var S = function (a, b, c) { s.beginPath(); s.shadowColor = 'rgba(0,0,0,0)'; s.font = "normal 24px Tahoma, Arial, Sans-Serif"; s.fillStyle = "#" + n.defaultText; s.textAlign = "center"; var d = q[E]; var e = D; B.push(e); for (var i = 0, length = d.construction.length; i < length; i++) { e = e + d.construction[i]; e = (e >= 12) ? e - 12 : e; B.push(e) } for (var i = 0, length = o.length; i < length, pitch = o[i]; i++) { if (B.indexOf(i) !== -1) { s.fillStyle = "#" + n.selectedText } else { s.shadowColor = 'rgba(0,0,0,0)'; s.fillStyle = "#" + n.defaultText } if (C.indexOf(i) !== -1) { s.shadowColor = "#" + n.highlightedShadow; s.shadowOffsetX = 0; s.shadowOffsetY = 0; s.shadowBlur = 10 } else { s.shadowColor = 'rgba(0,0,0,0)'; s.shadowOffsetX = 0; s.shadowOffsetY = 0; s.shadowBlur = 0 } var x = Math.round(Math.cos((i + 10) * Math.PI / 6) * c); var y = Math.round(Math.sin((i + 10) * Math.PI / 6) * c); var f = null; T(1, 0, 0, 1, b.x, b.y); U(1.06, 1.06); V(a * Math.PI); W(x, y); V((i + 1) * Math.PI / 6); if (BrowserDetect.browser !== "Safari") { s.fillText(pitch, 0, 0) } else { s.strokeText(pitch, 0, 0) } v = u; T(1, 0, 0, 1, b.x, b.y); U(0.973, 0.973); V(a * Math.PI); W(x, y); V((i + 1) * Math.PI / 6); w = u; A.push({ pitchIndex: i, pitchTransformationMatrix: v, lineTransformationMatrix: w }) } s.closePath() }; h.getPitches = function () { return A }; var T = function (a, b, c, d, e, f) { s.setTransform(a, b, c, d, e, f); u = [[a, c, 0], [b, d, 0], [e, f, 1]] }; var U = function (a, b) { s.scale(a, b); var m = [[a, 0, 0], [0, b, 0], [0, 0, 1]]; u = be(m, u) }; var V = function (a) { s.rotate(a); var m = [[Math.cos(a), Math.sin(a), 0], [-Math.sin(a), Math.cos(a), 0], [0, 0, 1]]; u = be(m, u) }; var W = function (x, y) { s.translate(x, y); var m = [[1, 0, 0], [0, 1, 0], [x, y, 1]]; u = be(m, u) }; var X = function (e, a) { var x; var y; if (e.touches !== undefined) { x = e.touches[0].pageX + document.body.scrollLeft + document.documentElement.scrollLeft; y = e.touches[0].pageY + document.body.scrollTop + document.documentElement.scrollTop } else { if (e.pageX != undefined && e.pageY != undefined) { x = e.pageX; y = e.pageY } else { x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft; y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop } } if (a) { x -= r.offsetLeft; y -= r.offsetTop } return { x: x, y: y} }; var Y = function (e) { if (e.touches !== undefined) { if (e.touches.length === 1) { e.preventDefault() } } else { e.preventDefault() } if (I) { document.documentElement.style.cursor = "pointer"; var a = X(e, false); if (J === null) { J = a } var b = J.x - a.x; var c = J.y - a.y; var d = r.offsetTop + (r.height / 2); var f = r.offsetLeft + (r.width / 2); if (a.y > d) { b *= -1 } if (a.x < f) { c *= -1 } var g = (Math.abs(b) > Math.abs(c)) ? b : c; M = g / ((new Date() - L)); F -= (1 / 1024) * g; if (F < 0) { F = 2 + F } else if (F >= 2) { F = F - 2 } J = a; K = true; R(F); L = new Date() } }; var Z = function (e) { if (!I) { var a = X(e, true) } }; var ba = function (e) { if (N === null) { var a = X(e, true); for (var i = 0, length = A.length; i < length, pitchObject = A[i]; i++) { if (a.x <= pitchObject.pitchTransformationMatrix[2][0] + 30 && a.x >= pitchObject.pitchTransformationMatrix[2][0] - 30 && a.y <= pitchObject.pitchTransformationMatrix[2][1] + 30 && a.y >= pitchObject.pitchTransformationMatrix[2][1] - 30) { if (B.indexOf(pitchObject.pitchIndex) !== -1 && C.indexOf(pitchObject.pitchIndex) === -1) { C.push(pitchObject.pitchIndex); K = true; messiaen.audio.loadPitch(o[pitchObject.pitchIndex]) } else if (C.indexOf(pitchObject.pitchIndex) !== -1) { C.splice(C.indexOf(pitchObject.pitchIndex), 1); K = true } } } } }; var bb = function (e) { var e = e || window.event; var a = e.keyCode || e.which; switch (a) { case 37: F -= 1 / 128; if (F < 0) { F = 2 + F } K = true; break; case 40: C = []; E = (E < 6) ? E + 1 : 0; K = true; break; case 39: F += 1 / 128; if (F >= 2) { F = F - 2 } K = true; break; case 38: C = []; E = (E > 0) ? E - 1 : 6; K = true; break } }; var bc = function (a) { var b = a; var c = 0; while (b != D) { c++; b++; if (b === 12) { b = 0 } } for (var i = 0, length = p.length; i < length, pitchAngle = p[i]; i++) { if (pitchAngle.pitchIndex === D) { if (F < pitchAngle.middle - 1 / 64 || F > pitchAngle.middle + 1 / 64) { if (c <= 6) { F -= 1 / 64; if (F < 0) { F = 2 + F } } else { F += 1 / 64; if (F >= 2) { F = F - 2 } } K = true; setTimeout(function () { bc(a) }, 1) } break } } }; var bd = function () { var a = []; for (var k = 0, length = C.length; k < length; k++) { a.push(o[C[k]]) } messiaen.audio.playChord(a) }; var be = function (a, b) { var c = Q(); for (var x = 0; x < 3; x++) { for (var y = 0; y < 3; y++) { var d = 0; for (var z = 0; z < 3; z++) { d += a[x][z] * b[z][y] } c[x][y] = d } } return c }; return h } (); window.onload = function () { messiaen.diagram.initialise() };